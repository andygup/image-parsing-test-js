<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title></title>
    <style>
        table,th,td
        {
            border:1px solid black;
        }
        .images{
            height: 50px;
            width: 50px;
        }
    </style>
</head>
<body>
<div style="font-size: large;">Convert binary image to base64 test</div>
<br><br>
<table >
    <tr>
        <th>Type</th>
        <th>image_3.9mb.jpg</th>
        <th>image_2.1mb.jpg</th>
        <th>image_1.5mb.jpg</th>
        <th>image_800kb.jpg</th>
        <th>image_405kb.jpg</th>
        <th>image_252kb.jpg</th>
        <th>image_100kb.jpg</th>
        <th>image_58kb.jpg</th>
        <th>image_27kb.jpg</th>
    </tr>
    <tr>
        <th>Size</th>
        <td id="size_image_3.9mb.jpg"></td>
        <td id="size_image_2.1mb.jpg"></td>
        <td id="size_image_1.5mb.jpg"></td>
        <td id="size_image_800kb.jpg"></td>
        <td id="size_image_405kb.jpg"></td>
        <td id="size_image_252kb.jpg"></td>
        <td id="size_image_100kb.jpg"></td>
        <td id="size_image_58kb.jpg"></td>
        <td id="size_image_27kb.jpg"></td>
    </tr>

    <tr>
        <th>FileReader</th>
        <td id="fr_image_3.9mb.jpg"></td>
        <td id="fr_image_2.1mb.jpg"></td>
        <td id="fr_image_1.5mb.jpg"></td>
        <td id="fr_image_800kb.jpg"></td>
        <td id="fr_image_405kb.jpg"></td>
        <td id="fr_image_252kb.jpg"></td>
        <td id="fr_image_100kb.jpg"></td>
        <td id="fr_image_58kb.jpg"></td>
        <td id="fr_image_27kb.jpg"></td>
    </tr>
    <tr>
        <th>Bitwise</th>
        <td id="b64_image_3.9mb.jpg"></td>
        <td id="b64_image_2.1mb.jpg"></td>
        <td id="b64_image_1.5mb.jpg"></td>
        <td id="b64_image_800kb.jpg"></td>
        <td id="b64_image_405kb.jpg"></td>
        <td id="b64_image_252kb.jpg"></td>
        <td id="b64_image_100kb.jpg"></td>
        <td id="b64_image_58kb.jpg"></td>
        <td id="b64_image_27kb.jpg"></td>
    </tr>
    <tr>
        <th>Canvas</th>
        <td id="can_image_3.9mb.jpg"></td>
        <td id="can_image_2.1mb.jpg"></td>
        <td id="can_image_1.5mb.jpg"></td>
        <td id="can_image_800kb.jpg"></td>
        <td id="can_image_405kb.jpg"></td>
        <td id="can_image_252kb.jpg"></td>
        <td id="can_image_100kb.jpg"></td>
        <td id="can_image_58kb.jpg"></td>
        <td id="can_image_27kb.jpg"></td>
    </tr>
    <tr>
        <th>Images</th>
        <td><img src="img/image_3.9mb.jpg" class="images"/></td>
        <td><img src="img/image_2.1mb.jpg" class="images"/></td>
        <td><img src="img/image_1.5mb.jpg" class="images"/></td>
        <td><img src="img/image_800kb.jpg" class="images"/></td>
        <td><img src="img/image_405kb.jpg" class="images"/></td>
        <td><img src="img/image_252kb.jpg" class="images"/></td>
        <td><img src="img/image_100kb.jpg" class="images"/></td>
        <td><img src="img/image_58kb.jpg" class="images"/></td>
        <td><img src="img/image_27kb.jpg" class="images"/></td>
    </tr>
</table>
<br><br>

<table >
    <tr>
        <th>Type</th>
        <th>image_3.9mb.png</th>
        <th>image_2.1mb.png</th>
        <th>image_1.5mb.png</th>
        <th>image_800kb.png</th>
        <th>image_405kb.png</th>
        <th>image_252kb.png</th>
        <th>image_100kb.png</th>
        <th>image_58kb.png</th>
        <th>image_27kb.png</th>
    </tr>
    <tr>
        <th>Size</th>
        <td id="size_image_3.9mb.png"></td>
        <td id="size_image_2.1mb.png"></td>
        <td id="size_image_1.5mb.png"></td>
        <td id="size_image_800kb.png"></td>
        <td id="size_image_405kb.png"></td>
        <td id="size_image_252kb.png"></td>
        <td id="size_image_100kb.png"></td>
        <td id="size_image_58kb.png"></td>
        <td id="size_image_27kb.png"></td>
    </tr>

    <tr>
        <th>FileReader</th>
        <td id="fr_image_3.9mb.png"></td>
        <td id="fr_image_2.1mb.png"></td>
        <td id="fr_image_1.5mb.png"></td>
        <td id="fr_image_800kb.png"></td>
        <td id="fr_image_405kb.png"></td>
        <td id="fr_image_252kb.png"></td>
        <td id="fr_image_100kb.png"></td>
        <td id="fr_image_58kb.png"></td>
        <td id="fr_image_27kb.png"></td>
    </tr>
    <tr>
        <th>Bitwise</th>
        <td id="b64_image_3.9mb.png"></td>
        <td id="b64_image_2.1mb.png"></td>
        <td id="b64_image_1.5mb.png"></td>
        <td id="b64_image_800kb.png"></td>
        <td id="b64_image_405kb.png"></td>
        <td id="b64_image_252kb.png"></td>
        <td id="b64_image_100kb.png"></td>
        <td id="b64_image_58kb.png"></td>
        <td id="b64_image_27kb.png"></td>
    </tr>
    <tr>
        <th>Canvas</th>
        <td id="can_image_3.9mb.png"></td>
        <td id="can_image_2.1mb.png"></td>
        <td id="can_image_1.5mb.png"></td>
        <td id="can_image_800kb.png"></td>
        <td id="can_image_405kb.png"></td>
        <td id="can_image_252kb.png"></td>
        <td id="can_image_100kb.png"></td>
        <td id="can_image_58kb.png"></td>
        <td id="can_image_27kb.png"></td>
    </tr>
    <tr>
        <th>Images</th>
        <td><img src="img/image_3.9mb.png" class="images"/></td>
        <td><img src="img/image_2.1mb.png" class="images"/></td>
        <td><img src="img/image_1.5mb.png" class="images"/></td>
        <td><img src="img/image_800kb.png" class="images"/></td>
        <td><img src="img/image_405kb.png" class="images"/></td>
        <td><img src="img/image_252kb.png" class="images"/></td>
        <td><img src="img/image_100kb.png" class="images"/></td>
        <td><img src="img/image_58kb.png" class="images"/></td>
        <td><img src="img/image_27kb.png" class="images"/></td>
    </tr>
</table>

<script>

    var imageArrJPG = ["image_1.5mb.jpg","image_3.9mb.jpg","image_2.1mb.jpg","image_27kb.jpg","image_100kb.jpg","image_252kb.jpg","image_405kb.jpg","image_58kb.jpg","image_800kb.jpg"];
    var imageArrPNG = ["image_1.5mb.png","image_3.9mb.png","image_2.1mb.png","image_27kb.png","image_100kb.png","image_252kb.png","image_405kb.png","image_58kb.png","image_800kb.png"];
    var jpgCounterArray = [];

    window.performance = window.performance || {};
    performance.now = (function () {
        return performance.now ||
                performance.mozNow ||
                performance.msNow ||
                performance.oNow ||
                performance.webkitNow ||
                function () {
                    return new Date().getTime();
                };
    })();

    for(var i = 0; i < imageArrJPG.length; i++){
        getImageFromServer("img/" + imageArrJPG[i],i,function(result,count){
            console.log("RESULT " + result);

            jpgCounterArray.push(count);

            if(jpgCounterArray.length == imageArrJPG.length){
                console.log("JPG's finished start testing PNGs")
                runPNGImages();
            }
        })
    }

    function runPNGImages(){

        for(var i = 0; i < imageArrJPG.length; i++){
            getImageFromServer("img/" + imageArrPNG[i],i,function(result){
                console.log("RESULT " + result);
            })
        }
    }

    function getImageFromServer(/* String */ path, count, callback){
        var xhr = new XMLHttpRequest();
        xhr.path = path;
        xhr.open("GET",path,true);
        xhr.responseType = "arraybuffer";
        xhr.onload = function(e){
            if(this.status == 200){
                console.log("Image size: " + this.response.byteLength + " bytes")
                var path = xhr.path.split("/");
                document.getElementById("size_" + path[1]).innerHTML = this.response.byteLength;

//                var start1 = performance.now();
//                var b64 = _base64ArrayBuffer(this.response);
//                var end1 = performance.now() - start1;
//
//                document.getElementById("b64_" + path[1]).innerHTML = end1;
//                console.log("B64 path: " + xhr.path + ", time: " + end1);

                doFileReader(this.response,path,function(path,endTime){
                    document.getElementById("fr_" + path[1]).innerHTML = endTime;

                    doCanvas(this.response,xhr.path,function(path,endTime){
                        document.getElementById("can_" + path).innerHTML = endTime;

                        var start1 = performance.now();
                        var b64 = _base64ArrayBuffer(this.response);
                        var end1 = performance.now() - start1;

                        document.getElementById("b64_" + path).innerHTML = end1;
                        console.log("B64 path: " + path + ", time: " + end1);
                    }.bind(this))
                }.bind(this))

                callback(this.response,count);
            }
            else{
                console.log("Problem retrieving image " + JSON.stringify(e))
            }
        }
        xhr.send();
    }

    function doFileReader(response,path,callback){
        var start2 = performance.now();
        var uInt8Array = new Uint8Array(response);
        var blob = new Blob([uInt8Array],{type:"image/jpeg"})
        var reader = new FileReader();
        reader.path = path;
        reader.time = start2;
        reader.onloadend = function(evt){
            var endTime = performance.now() - reader.time;
            var path = reader.path;
            callback(path,endTime);
        }

        reader.readAsDataURL(blob);
    }

    function doCanvas(response,path,callback){
        var start3 = performance.now();
        var canvas = document.createElement('CANVAS');
        var ctx = canvas.getContext('2d');
        var img = new Image;
        img.time = start3;
        img.path = path
        img.crossOrigin = 'Anonymous';
        img.onload = function(){
            var dataURL;
            canvas.height = img.height;
            canvas.width = img.width;
            ctx.drawImage(img,img.height,img.width);
            dataURL = canvas.toDataURL('image/png');
            var endTime3 = performance.now() - img.time;
            var path = img.path.split("/");
            console.log("CANVAS TIME " + endTime3 + ", path: " + path[1]);
            callback(path[1],endTime3);
            canvas = null;
        };
        img.src = path;
    }

    /**
     * Convert an ArrayBuffer to base64. My testing shows this to be
     * much faster than combining Blobs and btoa().
     * ALL CREDITS: https://gist.github.com/jonleighton/958841
     * NO licensing listed at the gist repo.
     * @param arrayBuffer
     * @returns {string}
     * @private
     */
    function _base64ArrayBuffer(arrayBuffer) {
        var base64    = ''
        var encodings = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/'

        var bytes         = new Uint8Array(arrayBuffer)
        var byteLength    = bytes.byteLength
        var byteRemainder = byteLength % 3
        var mainLength    = byteLength - byteRemainder

        var a, b, c, d
        var chunk

        // Main loop deals with bytes in chunks of 3
        for (var i = 0; i < mainLength; i = i + 3) {
            // Combine the three bytes into a single integer
            chunk = (bytes[i] << 16) | (bytes[i + 1] << 8) | bytes[i + 2]

            // Use bitmasks to extract 6-bit segments from the triplet
            a = (chunk & 16515072) >> 18 // 16515072 = (2^6 - 1) << 18
            b = (chunk & 258048)   >> 12 // 258048   = (2^6 - 1) << 12
            c = (chunk & 4032)     >>  6 // 4032     = (2^6 - 1) << 6
            d = chunk & 63               // 63       = 2^6 - 1

            // Convert the raw binary segments to the appropriate ASCII encoding
            base64 += encodings[a] + encodings[b] + encodings[c] + encodings[d]
        }

        // Deal with the remaining bytes and padding
        if (byteRemainder == 1) {
            chunk = bytes[mainLength]

            a = (chunk & 252) >> 2 // 252 = (2^6 - 1) << 2

            // Set the 4 least significant bits to zero
            b = (chunk & 3)   << 4 // 3   = 2^2 - 1

            base64 += encodings[a] + encodings[b] + '=='
        } else if (byteRemainder == 2) {
            chunk = (bytes[mainLength] << 8) | bytes[mainLength + 1]

            a = (chunk & 64512) >> 10 // 64512 = (2^6 - 1) << 10
            b = (chunk & 1008)  >>  4 // 1008  = (2^6 - 1) << 4

            // Set the 2 least significant bits to zero
            c = (chunk & 15)    <<  2 // 15    = 2^4 - 1

            base64 += encodings[a] + encodings[b] + encodings[c] + '='
        }

        return base64
    }
</script>

</body>
</html>